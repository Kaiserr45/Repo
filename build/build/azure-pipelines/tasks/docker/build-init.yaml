parameters:
  AppsettingsPath: ''

steps:
  #: 'Считывает метаданные для лейблов образа из файла appsettings.json и публикует их в переменных'
  - script: |
      #!/bin/bash

      set -e
      vsoPrefix="##"
      vsoWarning="${vsoPrefix}vso[task.logissue type=warning;]"
      vsoError="${vsoPrefix}vso[task.logissue type=error;]"
      vsoSection="${vsoPrefix}[section]"
      
      usage()
      {
          echo "${vsoError} script parameter error! Check keys and syntax!
          $0 -ap \"$(Build.SourcesDirectory)/myCoolApp/appsettings.json\""
      }
      
      #################### READ PARAMETERS #####################
      appsettingsPath="${{ parameters.AppsettingsPath }}"
      ###########################################################
      
      #################### INPUT VALIDATION #####################

      
      if [ ! "$BUILD_SOURCEVERSION" ]; then
          echo "${vsoError}BUILD_SOURCEVERSION IS NULL! Perhaps you are running the script out of TFS pipeline?"
          exit 1
      fi
      
      if [ ! "$BUILD_REPOSITORY_URI" ]; then
          echo "${vsoError}BUILD_REPOSITORY_URI IS NULL! Perhaps you are running the script out of TFS pipeline?"
          exit 1
      fi
      ###########################################################
      
      ################ READING APPSETTINGS.JSON #################
      
      revision="${BUILD_SOURCEVERSION}"
      source="${BUILD_REPOSITORY_URI}"
      created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
      vendor="СПАО \"Ингосстрах\""
      ###########################################################
        
      ############## POPULATING PIPELINE VARIABLES ##############
      echo "${vsoPrefix}vso[task.setvariable variable=buildVersion;]${BUILD_BUILDNUMBER}"
      echo "${vsoPrefix}vso[task.setvariable variable=org_opencontainers_image_created;]$created"
      echo "${vsoPrefix}vso[task.setvariable variable=org_opencontainers_image_source;]$source"
      echo "${vsoPrefix}vso[task.setvariable variable=org_opencontainers_image_version;]${BUILD_BUILDNUMBER}"
      echo "${vsoPrefix}vso[task.setvariable variable=org_opencontainers_image_revision;]$revision"
      echo "${vsoPrefix}vso[task.setvariable variable=org_opencontainers_image_vendor;]$vendor"
      ###########################################################
    displayName: 'Read metadata for build'